<!DOCTYPE html><script type="module">
import App, { Vec3, Quat, Mat4, Transform } from "../fungi/App.js";
import { IKPose_Human, IKCompute_Human, IKPose_Human_Debug } from "../fungi.ik/IKAnimationCompute.js";

import MixamoAnimator	from "../fungi.test/MixamoAnimator.js";

//import CharRig			from "../fungi.test/rigs/VegetaRig.js";
//import CharRig			from "../fungi.test/rigs/TinaRig.js";
import CharRig			from "../fungi.test/rigs/BoxyRig.js";

//#####################################################
App
	.init( true )
	.use_lighting( true )
	.load_pkg( { name:"fungi.armature", bone_view:true, mat:true } )
	.load_pkg( { name:"fungi.ik", spring:true } )
	.use_events()
	.use_debug()
	.set_camera( 0, 20, 3, 0, 0.9, 0 )
	.task( init )
	.then();

//#####################################################
let gAnim, gIKPose, gRig;

function on_render( dt, ss ){
	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	gAnim.tick( dt, true )					// Generate Pose for Src Armature
			.update_ik_pose( gIKPose, true )	// Convert Pose to IKPose
			.apply_pose();						// Apply Pose to Src Armature

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	gIKPose.apply_rig( gRig.rig );			// Apply IK Pose to Rig's Working Pose
	gRig.rig.apply_pose();					// Apply Working Pose to Bone Entities
}

async function init(){
	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Setup
	App.ecs.systems.get( "LightSystem" ).cls.ambient_color = "#303030";

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Load Character
	gRig = new CharRig();
	await gRig.load( "../files/models/", { 
		see_bones : false
	});

	gRig.node.set_pos( [1.0,0,0] );
	gRig.node.set_scl( 0.9 );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Load Animation
	gIKPose = new IKPose_Human();
	gAnim 	= new MixamoAnimator();

	//await gAnim.load( "../files/anim/Catwalk" );
	await gAnim.load( "../files/anim/Walking" );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	//on_render( 0.1 );
	App.render_by( 1, on_render );
	return true;
}

/*
-- [ 1 ] upperleg.L
---- [ 2 ] shin.L
---------- [ 5 ] upperarm.L
gltf_test.html:53 ------------ [ 6 ] arm.L
*/

//#####################################################
</script>
<html><head><style>html,body{ margin:0px; padding:0px; width:100%; height:100%; }</style>
</head><body><canvas id="pg_canvas"></canvas></body></html>